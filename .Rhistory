library(lubridate)
library(dplyr)
library(metR)
library(sm)
library(splines2)
library(RmarineHeatWaves)
library(hydrospatial)
library(rstudioapi)
library(tidyr)
source("r_src/helper_functions.R")
source("r_src/all_year.R")
source("r_src/dry_season.R")
source("r_src/flow_initiation_flush.R")
source("r_src/highflow.R")
source("r_src/flow_recession.R")
source("r_src/wet_season_baseflow.R")
source("r_src/getFFMetrics.R")
mer_hydrology <- read.csv("data/FlowMER_Streamflow_2014-20.csv")
prg_gg        <- unique(mer_hydrology[, c("Valley", "Site")])
val_site <- c("GLB_McCoys",     "GLB_Murchison", "MBG_Redbank",
"MBG_Maude",      "MBG_Darlington", "GWY_Millewa",
"GWY_Allambie", "LCH_Hillston",
"LCH_Booligal",   "LCH_Whealbah", "LCH_Merrimajeel",
"WRG_Cunnamulla", "EWK_ColligenOfftake", "EWK_Barham Moulamien",
"EWK_Gee Gee Bridge", "GWY_Gundare", "EWK_YallakoolOfftake")
#val_site <- "WRG_Cunnamulla"
val_site <- data.frame(t(matrix(unlist(strsplit(val_site, "_")), ncol = length(val_site))))
colnames(val_site) <- c("Valley", "Site")
seq(1, dim(val_site)[1])
val_site
val_site <- val_site[c(14, 15)]
val_site <- val_site[c(14, 15), ]
val_site
val_site <- val_site[c(12, 13), ]
for (i in seq(1, dim(val_site)[1]))
{
rm(flow_matrix_obs, flow_fil_flw, flow_matrix_cf)
valley <- val_site$Valley[i]
site   <- val_site$Site[i]
out_file   <- "veg_gauges_out"
out_file_2 <- paste0(out_file, "/", valley, "_", site)
if (!dir.exists(out_file)) dir.create(out_file)
dir.create(out_file_2)
gg              <- prg_gg[which(prg_gg$Valley  == valley & prg_gg$Site == site), ]
flow_fil        <- filter(mer_hydrology, Site == gg$Site & Category == "Flow")
flow_fil_gg     <- flow_fil[, c("Date", "Flow")]
str_dt          <- as.Date(paste0(year(min(flow_fil$Date)) - 1, "-07-01"))
flow_matrix_obs <- makeFlowMatrix(flow_fil_gg, str_dt)$flow_deep
# ---------
# CF values
# ---------
flow_fil_flw    <- filter(mer_hydrology, Site == gg$Site & Category == "Flow")
flow_fil_cew    <- filter(mer_hydrology, Site == gg$Site & Category == "CEW")
flow_fil_flw_cw <- left_join(flow_fil_flw, flow_fil_cew, by = "Date")
flow_fil_flw_cw$Flow.y[is.na(flow_fil_flw_cw$Flow.y)] <- 0
flow_fil_flw_cw$Flow_CF <- as.numeric(flow_fil_flw_cw$Flow.x) - as.numeric(flow_fil_flw_cw$Flow.y)
flow_fil_gg     <- flow_fil_flw_cw[, c("Date", "Flow_CF")]
colnames(flow_fil_gg) <- c("Date", "Flow")
str_dt          <- as.Date(paste0(year(min(flow_fil$Date)) - 1, "-07-01"))
flow_matrix_cf  <- makeFlowMatrix(flow_fil_gg, str_dt)$flow_deep
# ------------------
# Global hydrographs
# ------------------
plot_type <- "global_hydrograph"
file <- paste0(out_file_2, "/", valley, "_", site, "_", plot_type, ".png")
png(filename = file,
bg = "white", width =  14, height = 7, units = 'in', res = 300)
max_val  <- quantile(flow_matrix_obs$Flow, probs = 0.95) + quantile(flow_matrix_obs$Flow, probs = 0.95) / 2
max_val2 <- quantile(flow_matrix_obs$Flow, probs = 0.90) + quantile(flow_matrix_obs$Flow, probs = 0.90) / 2
plot(flow_matrix_obs$Date, flow_matrix_obs$Flow,
type = "l", lwd = 3,
xlab = 'Date',
ylab = 'Flow (ML/d)', col = "purple", ylim = c(0, max_val))
lines(flow_matrix_cf$Date, flow_matrix_cf$Flow, col = "red", lwd = 2)
flow_matrix_cf$cols <- flow_matrix_cf$Season
flow_matrix_cf$cols <- factor(flow_matrix_cf$Season, labels = c("orange", "brown", "blue", "yellow"))
points(flow_matrix_cf$Date, flow_matrix_cf$Flow,
col = as.character(flow_matrix_cf$cols),
cex = 0.8, pch = 16)
legend("topleft", legend=c("Counterfactual", "Observed"),
col=c("red", "purple"), lty=1, cex=1)
legend("topright", legend = c("Winter", "Spring", "Summer", "Autumn"),
col = c("blue", "yellow", "orange", "brown"),
pch = 16,
cex = 1)
dev.off()
# -----------------------
# Observed flows compute
# -----------------------
par(mfrow = c(2, 3))
flow_type       <- "observed"
plot_out_base   <- paste0(out_file_2, "/", valley, "_", site, "_", flow_type)
if (site == "Cunnamulla")
{
out_metrics_obs <- getFFMetrics(flow_matrix_obs, plot_out_base = plot_out_base, last_date_cutoff_flush = 300)
} else {
out_metrics_obs <- getFFMetrics(flow_matrix_obs, plot_out_base = plot_out_base)
}
# -----------------------
# Observed flows compute
# -----------------------
dev.off()
par(mfrow = c(2, 3))
flow_type      <- "counterfactual"
plot_out_base  <- paste0(out_file_2, "/", valley, "_", site, "_", flow_type)
if (site == "Cunnamulla")
{
out_metrics_cf <- getFFMetrics(flow_matrix_cf, plot_out_base = plot_out_base, last_date_cutoff_flush = 300)
} else {
out_metrics_cf <- getFFMetrics(flow_matrix_cf, plot_out_base = plot_out_base)
}
# ---------
# Write out
# ---------
write.csv(out_metrics_obs$FFmetrics, file = paste0(out_file_2, "/", valley, "_", site, "_observed_metrics.csv"))
write.csv(out_metrics_cf$FFmetrics,  file = paste0(out_file_2, "/", valley, "_", site, "_counterfactual_metrics.csv"))
}
rm(flow_matrix_obs, flow_fil_flw, flow_matrix_cf)
val_site
val_site
val_site <- c("GLB_McCoys",     "GLB_Murchison", "MBG_Redbank",
"MBG_Maude",      "MBG_Darlington", "GWY_Millewa",
"GWY_Allambie", "LCH_Hillston",
"LCH_Booligal",   "LCH_Whealbah", "LCH_Merrimajeel",
"WRG_Cunnamulla", "EWK_ColligenOfftake", "EWK_Barham Moulamien",
"EWK_Gee Gee Bridge", "GWY_Gundare", "EWK_YallakoolOfftake")
#val_site <- "WRG_Cunnamulla"
val_site <- data.frame(t(matrix(unlist(strsplit(val_site, "_")), ncol = length(val_site))))
colnames(val_site) <- c("Valley", "Site")
val_site <- val_site[c(12, 13), ]
for (i in seq(1, dim(val_site)[1]))
{
rm(flow_matrix_obs, flow_fil_flw, flow_matrix_cf)
valley <- val_site$Valley[i]
site   <- val_site$Site[i]
out_file   <- "veg_gauges_out"
out_file_2 <- paste0(out_file, "/", valley, "_", site)
if (!dir.exists(out_file)) dir.create(out_file)
dir.create(out_file_2)
gg              <- prg_gg[which(prg_gg$Valley  == valley & prg_gg$Site == site), ]
flow_fil        <- filter(mer_hydrology, Site == gg$Site & Category == "Flow")
flow_fil_gg     <- flow_fil[, c("Date", "Flow")]
str_dt          <- as.Date(paste0(year(min(flow_fil$Date)) - 1, "-07-01"))
flow_matrix_obs <- makeFlowMatrix(flow_fil_gg, str_dt)$flow_deep
# ---------
# CF values
# ---------
flow_fil_flw    <- filter(mer_hydrology, Site == gg$Site & Category == "Flow")
flow_fil_cew    <- filter(mer_hydrology, Site == gg$Site & Category == "CEW")
flow_fil_flw_cw <- left_join(flow_fil_flw, flow_fil_cew, by = "Date")
flow_fil_flw_cw$Flow.y[is.na(flow_fil_flw_cw$Flow.y)] <- 0
flow_fil_flw_cw$Flow_CF <- as.numeric(flow_fil_flw_cw$Flow.x) - as.numeric(flow_fil_flw_cw$Flow.y)
flow_fil_gg     <- flow_fil_flw_cw[, c("Date", "Flow_CF")]
colnames(flow_fil_gg) <- c("Date", "Flow")
str_dt          <- as.Date(paste0(year(min(flow_fil$Date)) - 1, "-07-01"))
flow_matrix_cf  <- makeFlowMatrix(flow_fil_gg, str_dt)$flow_deep
# ------------------
# Global hydrographs
# ------------------
plot_type <- "global_hydrograph"
file <- paste0(out_file_2, "/", valley, "_", site, "_", plot_type, ".png")
png(filename = file,
bg = "white", width =  14, height = 7, units = 'in', res = 300)
max_val  <- quantile(flow_matrix_obs$Flow, probs = 0.95) + quantile(flow_matrix_obs$Flow, probs = 0.95) / 2
max_val2 <- quantile(flow_matrix_obs$Flow, probs = 0.90) + quantile(flow_matrix_obs$Flow, probs = 0.90) / 2
plot(flow_matrix_obs$Date, flow_matrix_obs$Flow,
type = "l", lwd = 3,
xlab = 'Date',
ylab = 'Flow (ML/d)', col = "purple", ylim = c(0, max_val))
lines(flow_matrix_cf$Date, flow_matrix_cf$Flow, col = "red", lwd = 2)
flow_matrix_cf$cols <- flow_matrix_cf$Season
flow_matrix_cf$cols <- factor(flow_matrix_cf$Season, labels = c("orange", "brown", "blue", "yellow"))
points(flow_matrix_cf$Date, flow_matrix_cf$Flow,
col = as.character(flow_matrix_cf$cols),
cex = 0.8, pch = 16)
legend("topleft", legend=c("Counterfactual", "Observed"),
col=c("red", "purple"), lty=1, cex=1)
legend("topright", legend = c("Winter", "Spring", "Summer", "Autumn"),
col = c("blue", "yellow", "orange", "brown"),
pch = 16,
cex = 1)
dev.off()
# -----------------------
# Observed flows compute
# -----------------------
par(mfrow = c(2, 3))
flow_type       <- "observed"
plot_out_base   <- paste0(out_file_2, "/", valley, "_", site, "_", flow_type)
if (site == "Cunnamulla")
{
out_metrics_obs <- getFFMetrics(flow_matrix_obs, plot_out_base = plot_out_base, last_date_cutoff_flush = 300)
} else {
out_metrics_obs <- getFFMetrics(flow_matrix_obs, plot_out_base = plot_out_base)
}
# -----------------------
# Observed flows compute
# -----------------------
dev.off()
par(mfrow = c(2, 3))
flow_type      <- "counterfactual"
plot_out_base  <- paste0(out_file_2, "/", valley, "_", site, "_", flow_type)
if (site == "Cunnamulla")
{
out_metrics_cf <- getFFMetrics(flow_matrix_cf, plot_out_base = plot_out_base, last_date_cutoff_flush = 300)
} else {
out_metrics_cf <- getFFMetrics(flow_matrix_cf, plot_out_base = plot_out_base)
}
# ---------
# Write out
# ---------
write.csv(out_metrics_obs$FFmetrics, file = paste0(out_file_2, "/", valley, "_", site, "_observed_metrics.csv"))
write.csv(out_metrics_cf$FFmetrics,  file = paste0(out_file_2, "/", valley, "_", site, "_counterfactual_metrics.csv"))
}
20 * 1.6
16*1.6
# =========================================================
# Take a look at the data for the gauges of the vegetation
# analysis
# Author: Luke Lloyd-Jones
# Date started: 18/03/2021
# Date updated: 11/05/2021
# =========================================================
# Source the library dependencies
library(lubridate)
library(dplyr)
library(metR)
library(sm)
library(splines2)
library(RmarineHeatWaves)
library(hydrospatial)
library(rstudioapi)
library(tidyr)
source("r_src/helper_functions.R")
source("r_src/all_year.R")
source("r_src/dry_season.R")
source("r_src/flow_initiation_flush.R")
source("r_src/highflow.R")
source("r_src/flow_recession.R")
source("r_src/wet_season_baseflow.R")
source("r_src/getFFMetrics.R")
# --------------------------------------------------------------------
# Test data read for comparison
# --------------------------------------------------------------------
mer_hydrology <- read.csv("data/FlowMER_Streamflow_2014-20.csv")
prg_gg        <- unique(mer_hydrology[, c("Valley", "Site")])
val_site <- "WRG_Cunnamulla"
#val_site <- "WRG_Cunnamulla"
val_site <- data.frame(t(matrix(unlist(strsplit(val_site, "_")), ncol = length(val_site))))
colnames(val_site) <- c("Valley", "Site")
valley <- val_site$Valley[i]
site   <- val_site$Site[i]
out_file   <- "veg_gauges_out"
out_file_2 <- paste0(out_file, "/", valley, "_", site)
if (!dir.exists(out_file)) dir.create(out_file)
dir.create(out_file_2)
i <- 1
valley <- val_site$Valley[i]
site   <- val_site$Site[i]
out_file   <- "veg_gauges_out"
out_file_2 <- paste0(out_file, "/", valley, "_", site)
if (!dir.exists(out_file)) dir.create(out_file)
dir.create(out_file_2)
gg              <- prg_gg[which(prg_gg$Valley  == valley & prg_gg$Site == site), ]
flow_fil        <- filter(mer_hydrology, Site == gg$Site & Category == "Flow")
flow_fil_gg     <- flow_fil[, c("Date", "Flow")]
str_dt          <- as.Date(paste0(year(min(flow_fil$Date)) - 1, "-07-01"))
flow_matrix_obs <- makeFlowMatrix(flow_fil_gg, str_dt)$flow_deep
head(flow_matrix_obs)
?mean
?SD
?sd
getwd()
